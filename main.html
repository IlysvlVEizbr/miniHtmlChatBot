<html>
<head>
<script type="text/javascript">
// API相关参数
const ApiUrl = 'https://api.siliconflow.cn/v1/chat/completions';
const ApiKey = 'sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx';
const ApiModel = [
  'Qwen/Qwen2-7B-Instruct',
  'THUDM/glm-4-9b-chat',
  '01-ai/Yi-1.5-9B-Chat-16K'
];
// 预置系统提示词
const SysPrompt = [
  "You are a helpful assistant.",
  "You are a professional, authentic translation engine. Your function is to translate any text entered by user accurately into English, being polite and formal. Output translation directly without any additional text.",
  "You are a professional, authentic translation engine. Your function is to translate any text entered by user accurately into Chinese. Output translation directly without any additional text.",
];
// 固定用户提示词前缀
const TranslatePrompt = [
  "你是翻译官，请正式、礼貌地翻译我后续所有内容到英文：",
  "你是翻译官，请准确、流利地翻译我后续所有内容到中文："
];
// 起标题时用的系统提示词
const SummarizePrompt = "Your task is to summarize the given content, then create a short (lenght <9 words) title about it in Chinese. Output the title directly without any additional text or punctuation."
</script>
<title>AI Chat Bot</title>
<style type="text/css">
*{box-sizing:border-box;}
body{background-color:#eee;}
summary{margin-left:10px;}
::-webkit-scrollbar{width:5px;}
/* 滑块样式 */
::-webkit-scrollbar-thumb{background-color:#8888;border-radius:3px;}
/* 滚动条轨道样式 */
::-webkit-scrollbar-track{background-color:#0000;border-radius:3px;}
#mainTitle{font-size:2rem;text-align:center;margin:15px 0 5px;}
.mainBox{background-color:#ffe;border:2px solid;border-radius:8px;padding:10px;}
#chatBox{height:400px;overflow:auto;}
.hp-row.msgRow{padding:3px 10px;}
/* 用户信息气泡 */
.user.msg{background-color:#efd;float:right;border-radius:8px 8px 0 8px;}
.user.name{text-align:right;}
/* AI回复气泡 */
.bot.msg{background-color:#eff;float:left;border-radius:8px 8px 8px 0;}
.bot.name{text-align:left;}
.msg{border:1px solid;text-align:start;max-width:90%;padding:10px 15px;margin:2px 0 5px;}
.name{font-size:0.9rem;margin-top:2px;}
#experimentRow{padding:0 10px;}
.hp-row.optionRow{padding:5px 10px 0;}
.optionCell{padding:5px 0;}
#optionCell1{width:35%;}
#optionCell2{width:45%;}
#optionCell3{width:20%;}
.optionTitle{margin-left:10px;padding:8px 0;font-size:15px;}
.optionSelect{padding:8px;font-size:14px;margin-left:5px;}
.inputArea{width:100%;border:1px dotted;resize:none;padding:8px;font-size:1.1rem;font-family:Arial,"微软雅黑",sans-serif}
#inputContent{margin:8px 0 5px;}
.ctrlBtn{background-color:#fb3;height:50px;width:100%;border-radius:5px;font-size:1.2rem;}
.btnCell{width:33%;padding:5px 10px;}
.hp-row{display:table;padding:10px;width:100%;}
.hp-cell{min-width:10%;display:table-cell;}
/* 窄屏自适应布局 */
@media(max-width:850px){
  .hp-cell{width:100%;display:block;}
  #optionCell1{width:100%;}
  #optionCell2{width:100%;}
  #optionCell3{width:100%;}
}
</style>
</head>
<body>
  <div id="mainTitle">AI Chat Bot</div>
  <div class="hp-row">
	<div class="mainBox" id="chatBox">
	  <!-- 以下注释内容用于样式预览 -->
	  <!-- <div class="hp-row msgRow">
		<div class="user name">用户</div>
		<div class="user msg">你好，用户内容示例</div>
	  </div>
	  <div class="hp-row msgRow">
		<div class="bot name">AI</div>
		<div class="bot msg">你好，AI内容示例</div>
	  </div> -->
	</div>
  </div>
  <div class="hp-row" id="experimentRow">
	<div class="mainBox">
	  <details>
		<summary>实验性可选功能</summary>
		<div class="hp-row optionRow">
		  <div class="hp-cell optionCell" id="optionCell1">
			<span class="optionTitle">系统提示词</span>
			<select class="optionSelect" id="sysPromptSelect">
			  <option>默认</option>
			  <option>中译英助手</option>
			  <option>英译中助手</option>
			  <option>自定义</option>
			</select>
		  </div>
		  <div class="hp-cell optionCell" id="optionCell2">
			<span class="optionTitle">选用AI模型</span>
			<select class="optionSelect" id="modelSelect">
			  <option>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;</option>
			</select>
		  </div>
		  <div class="hp-cell optionCell" id="optionCell3">
			<span class="optionTitle">自动生成标题</span>
			<input type="checkbox" id="genTitleCheck"/>
		  </div>
		</div>
		<div class="hp-row optionRow" id="sysPromptInput">
		  <div class="optionTitle">自定义系统提示词</div>
		  <textarea class="inputArea"></textarea>
		</div>
	  </details>
	</div>
  </div>
  <div class="hp-row">
	<div class="mainBox">
	  <div>用户输入</div>
	  <textarea class="inputArea" id="inputContent" rows="4"></textarea>
	</div>
  </div>
  <div class="hp-row">
	<div class="hp-cell btnCell">
	  <button type="button" class="ctrlBtn" onclick="clearHis()">清除历史</button>
	</div>
	<div class="hp-cell btnCell">
	  <button type="button" class="ctrlBtn" onclick="sendMsg()">发送</button>
	</div>
	<div class="hp-cell btnCell">
	  <button type="button" class="ctrlBtn" onclick="reGen()">重新生成</button>
	</div>
  </div>
<script type="text/javascript">
class ChatBox {
  constructor(chatBoxId){
	this.cb = document.getElementById(chatBoxId);
	this.history = [];
  }
  scrollToBtm(){
	this.cb.scrollTop = this.cb.scrollHeight;
  }
  clearAll(){
	this.cb.innerHTML = '';
	this.history = [];
  }
  _msgStrToHtml(msgStr){
	msgStr = msgStr.trim();
	msgStr = msgStr.replace(/(\*\*+)([^*]+)\1/g, '<strong>$2</strong>'); // **粗体** 转html
	msgStr = msgStr.replace(/^(#+)\s+(.+)/gm, '<strong>$2</strong>'); // # 标题 转html
	return msgStr.replace(/\n/g, '<br>');
  }
  _appendMsg(msgStr, isUserMsg){
	const divClass = isUserMsg ? 'user' : 'bot';
	const userName = isUserMsg ? '用户' : 'AI';
	msgStr = this._msgStrToHtml(msgStr);
	const newHtml = `<div class="hp-row msgRow"><div class="${divClass} name">${userName}</div><div class="${divClass} msg">${msgStr}</div></div>`;
	this.cb.insertAdjacentHTML('beforeend', newHtml);
  }
  appendConvr(userMsgStr, botMsgStr){
	this._appendMsg(userMsgStr, true);
	this._appendMsg(botMsgStr, false);
	this.scrollToBtm();
	this.history.push([userMsgStr, botMsgStr]);
  }
  updateLastBotMsg(botMsgStr){
	this.history[this.history.length - 1][1] = botMsgStr;
	// 在转成HTML之前记录历史
	botMsgStr = this._msgStrToHtml(botMsgStr);
	this.cb.lastElementChild.querySelector('.bot.msg').innerHTML = botMsgStr;
	this.scrollToBtm();
  }
  popHistory(){
	const msgRows = Array.from(this.cb.getElementsByClassName('hp-row msgRow')); // 先转换为数组
	msgRows.slice(-2).forEach(elem => elem.remove()); // 选最后两个元素删除
	return this.history.pop();
  }
  getHistory(){
	return this.history.concat(); // 深拷贝数组
  }
}
class DynamicSysPrompt {
  constructor(sysPromptSelect, sysPromptInputId){
	this.sps = sysPromptSelect;
	this.spi = document.getElementById(sysPromptInputId);
	this.spc = this.spi.getElementsByTagName('textarea')[0];
	this.spi.style.display = 'none';
	this.sps.onchange = () => {
	  if (this.sps.selectedIndex==3){
		this.spi.style.display = 'table';
	  } else {
		this.spi.style.display = 'none';
	  }
	};
  }
  index(){
	return this.sps.selectedIndex;
  }
  get(){
	if (this.sps.selectedIndex==3){
	  return this.spc.value.trim();
	} else {
	  return SysPrompt[this.sps.selectedIndex];
	}
  }
}
class UserInput {
  constructor(userInputId){
	this.ta = document.getElementById(userInputId);
  }
  get(){
	return this.ta.value.trim();
  }
  set(content){
	this.ta.value = content;
  }
  clear(){
	this.ta.value = '';
  }
}
class ApiRequest {
  constructor(chatBox, dynSysPrompt, mainTitle, modelSelect, genTitleCheck){
	this.cb = chatBox;
	this.dsp = dynSysPrompt;
	this.mt = mainTitle;
	this.ms = modelSelect;
	this.gtc = genTitleCheck;
	this.options = {
	  method: 'POST',
	  headers: {accept: 'application/json', 'content-type': 'application/json', authorization: 'Bearer '+ApiKey},
	  body: ''
	};
  }
  sendChatRequest(userMsgStr, history){
	// console.log('开始生成回应', history);
	const temp_options_body = {
	  model: ApiModel[this.ms.selectedIndex],
	  messages: [{role: 'system', content: this.dsp.get()}],
	  stream: false,
	  max_tokens: 1536,
	  top_k: 20
	};
	if (this.dsp.index()==1)
	  temp_options_body.messages.push({role: 'user', content: TranslatePrompt[0]});
	else if (this.dsp.index()==2)
	  temp_options_body.messages.push({role: 'user', content: TranslatePrompt[1]});
	for (let i=0; i<history.length; i++){
	  temp_options_body.messages.push({role: 'user', content: history[i][0]});
	  temp_options_body.messages.push({role: 'assistant', content: history[i][1]});
	}
	temp_options_body.messages.push({role: 'user', content: userMsgStr});
	this.options.body = JSON.stringify(temp_options_body);
	fetch(ApiUrl, this.options)
	.then(response => response.json())
	.then(jsonData => {
	  // console.log('回应请求结果', jsonData);
	  this._chatResultHandler(jsonData['choices'][0]['message']['content']);
	  if (this.gtc.checked && history.length==0){
		this.generateTitle(this.cb.getHistory());
	  }
	})
	.catch(err => this._chatErrorHandler(err));
  }
  _chatResultHandler(botMsgStr){
	this.cb.updateLastBotMsg(botMsgStr);
	disableBtns(false);
  }
  _chatErrorHandler(err){
	console.warn(err);
	this.cb.updateLastBotMsg('错误：生成失败');
	disableBtns(false);
  }
  _setTitle(titleStr){
	titleStr = titleStr.replace(/\"/g, '').trim();
	titleStr = titleStr.replace(/[。\.]$/,'');
	document.title = titleStr;
	this.mt.innerHTML = titleStr;
  }
  generateTitle(history){
	// console.log('开始生成标题', history);
	if (this.dsp.index()==1){
	  this._setTitle('翻译到英文');
	  return;
	} else if (this.dsp.index()==2){
	  this._setTitle('翻译到中文');
	  return;
	}
	const temp_options_body = {
	  model: ApiModel[this.ms.selectedIndex],
	  messages: [{role: 'system', content: SummarizePrompt}],
	  stream: false,
	  max_tokens: 9,
	  top_k: 15
	};
	temp_options_body.messages.push({role: 'user', content: '直接输出短标题，其中避免含有标点符号。以下为JSON形式的待起标题对话：'+JSON.stringify(history[0])});
	this.options.body = JSON.stringify(temp_options_body);
	fetch(ApiUrl, this.options)
	.then(response => response.json())
	.then(jsonData => {
	  // console.log('标题请求结果', jsonData);
	  this._setTitle(jsonData['choices'][0]['message']['content']);
	})
	.catch(err => {});
  }
}
const mainTitle = document.getElementById('mainTitle');
const sysPromptSelect = document.getElementById('sysPromptSelect');
const modelSelect = document.getElementById('modelSelect');
const genTitleCheck = document.getElementById('genTitleCheck');
const btns = document.getElementsByClassName('ctrlBtn');
const chatBox = new ChatBox('chatBox');
const dynSysPrompt = new DynamicSysPrompt(sysPromptSelect, 'sysPromptInput');
const userInput = new UserInput('inputContent');
const apiRequest = new ApiRequest(chatBox, dynSysPrompt, mainTitle, modelSelect, genTitleCheck);
modelSelect.firstElementChild.remove() // 删除占位选项
for (model of ApiModel){
  // 可用模型选项动态导入
  modelSelect.insertAdjacentHTML('beforeend', `<option>${model}</option>`);
}
function disableBtns(flag){
  for (btn of btns){
	btn.disabled = flag;
  }
}
function clearHis(){
  chatBox.clearAll();
  document.title = 'AI Chat Bot';
  mainTitle.innerHTML = 'AI Chat Bot';
}
function sendMsg(){
  predict(userInput.get());
  userInput.clear();
}
function reGen(){
  if (chatBox.getHistory().length < 1){
	console.warn('对话历史为空');
	return;
  }
  predict(chatBox.popHistory()[0]);
}
function predict(userMsgStr){
  if (userMsgStr == ''){
	console.warn('用户输入为空');
	return;
  }
  disableBtns(true);
  const history = chatBox.getHistory();
  // 在添加"生成中"之前提取历史记录
  chatBox.appendConvr(userMsgStr, '正在生成中……');
  apiRequest.sendChatRequest(userMsgStr, history);
}
// 通过URL参数快速开始对话，可用作自定义搜索引擎
const urlPrompt = (new URLSearchParams(location.search)).get('s');
if (urlPrompt){
  userInput.set(urlPrompt);
  sendMsg();
}
</script>
</body>
</html>